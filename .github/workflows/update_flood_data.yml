name: Update Flood Data

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/update_flood_data.py'
      - '.github/workflows/update_flood_data.yml'
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: write

concurrency:
  group: update-flood-data
  cancel-in-progress: false

jobs:
  update-flood-data:
    runs-on: ubuntu-latest
    name: Fetch and Update Gauge Data

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: dev-rensith

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools
          pip install requests

      - name: Run update_flood_data.py
        id: scrape
        env:
          GAUGE_FEATURE_LAYER_URL: ${{ vars.GAUGE_FEATURE_LAYER_URL }}
          GAUGE_WHERE: ${{ vars.GAUGE_WHERE }}
        run: |
          set -euo pipefail
          echo "Starting flood data collection..."
          python scripts/update_flood_data.py

          RECORD_COUNT=$(python - <<'PY'
          import json
          from pathlib import Path
          data = json.loads(Path("data/gauges_2_view.json").read_text())
          print(data.get("record_count", 0))
          PY
          )

          echo "record_count=${RECORD_COUNT}" >> "$GITHUB_OUTPUT"
          echo "Successfully retrieved ${RECORD_COUNT} gauge records"

          if [ "$RECORD_COUNT" -eq 0 ]; then
            echo "Record count is 0; failing run to avoid committing empty data."
            exit 1
          fi

      - name: Check for data changes
        id: check-changes
        run: |
          set -euo pipefail
          CHANGES=$(git status --porcelain data/gauges_2_view.json data/gauges_2_view.csv | wc -l)
          echo "changes_count=${CHANGES}" >> "$GITHUB_OUTPUT"

          if [ "$CHANGES" -gt 0 ]; then
            echo "Changes detected in gauge data"
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes in gauge data, skipping commit"
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push to dev-rensith
        run: |
          set -euo pipefail
          git config user.name "RensithUdara"
          git config user.email "rensithudaragonalagoda@gmail.com"

          RECORD_COUNT=${{ steps.scrape.outputs.record_count }}
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          git add data/gauges_2_view.json data/gauges_2_view.csv
          
          if [ "${{ steps.check-changes.outputs.changes_detected }}" == "true" ]; then
            git commit -m "chore: update gauges_2_view data (${RECORD_COUNT} records, ${TIMESTAMP})"
          else
            git commit -m "chore: verify gauges_2_view data (${RECORD_COUNT} records, ${TIMESTAMP})" --allow-empty
          fi
          
          git push origin dev-rensith
          echo "Successfully pushed data update to dev-rensith branch"

      - name: Merge dev-rensith to main
        run: |
          set -euo pipefail
          git config user.name "RensithUdara"
          git config user.email "rensithudaragonalagoda@gmail.com"
          
          git fetch origin main
          git checkout main
          git merge dev-rensith --no-edit
          git push origin main
          echo "Successfully merged dev-rensith into main"

      - name: Upload data as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flood-data-${{ github.run_id }}
          path: data/gauges_2_view.json
          retention-days: 30
          compression-level: 9

      - name: Workflow summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Flood Data Update Summary

          - **Records Retrieved:** ${{ steps.scrape.outputs.record_count }}
          - **Data Changed:** ${{ steps.check-changes.outputs.changes_detected }}
          - **Changes Count:** ${{ steps.check-changes.outputs.changes_count }}
          - **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Workflow Run:** #${{ github.run_number }}

          ### Files Updated
          - data/gauges_2_view.json (JSON format with metadata)
          - data/gauges_2_view.csv (CSV format for spreadsheet applications)

          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "Workflow failed!"
          echo "Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
